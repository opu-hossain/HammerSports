{% extends 'base.html' %}
{% load static %}

{% block page_content %}

<div class="title">
    <h2>{{ post.title }}</h2>
</div>

<article>
    <small>
        {{post.created_on.date}} | Categories: 
            {% for category in post.categories.all %}
                <a href="{% url 'Blog_category' category.name %}">{{category.name}}</a>
            {% endfor %}
            {% if post.featured_image %}
                <img src="{{ post.featured_image.url }}" alt="{{ post.title }}">
            {% endif %}
    </small>
    <p>{{post.body | safe }}</p>
    <p>Tags: {% for tag in post.tags.all %}{{ tag.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
</article>


<section>
    <h3>Leave a Comment</h3>
    {% for message in messages %}
        <div class="alert alert-danger" role="alert">
            {{ message }}
        </div>
    {% endfor %}
    <form action="" method="post">
        {% csrf_token %}
            <div>{{form.author}}</div>
            <div>{{form.body}}</div>
            <button type="submit" class="btn btn-primary">Submit</button>
    </form>
</section>
<section>
    <h3>Related Posts:</h3>
    {% for related_post in related_posts|slice:":2" %}
        <article>
            <h2><a href="{% url 'Blog_details' slug=related_post.slug %}">{{ related_post.title }}</a></h2>
            {% if related_post.featured_image %}
                <img src="{{ related_post.featured_image.url }}" alt="{{ related_post.title }}">
            {% endif %}
        </article>
    {% empty %}
        <p>No related posts found.</p>
    {% endfor %}
</section>

<section>
    <h3>Comments:</h3>
    {% for comment in comments %}
        <article class="comment">
            {% if comment.author.has_profile_image %}
                <img src="{{ comment.author.profile_image.url }}" alt="{{ comment.author.username }}">
            {% else %}
                <img src="{% static 'default/default_profile_image.jpg' %}" alt="{{ comment.author.username }}">
            {% endif %}
            <p>On {{ comment.created_on|date:"F j, Y" }} <a href="{% url 'profile' username=comment.author.username %}"><b>{{ comment.author.username }}</b></a> wrote:</p>
            <p>{{ comment.body | linebreaks }}</p>
            {% if user.is_superuser or user.is_staff %}
                {% if not comment.approved %}
                    <form method="post" action="{% url 'comment_approve' comment.id %}">
                        {% csrf_token %}
                        <button type="submit">Approve</button>
                    </form>
                {% else %}
                    <p>Approved ✔</p>
                {% endif %}
            {% endif %}
            <button class="reply-button">Reply</button>
            <div class="reply-form" style="display: none;">
                <form method="post" action="{% url 'comment_create' post.slug %}">
                    {% csrf_token %}
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <textarea name="body" required></textarea>
                    <button type="submit">Submit Reply</button>
                </form>
            </div>
            {% if comment.replies %}
                <div class="replies">
                    {% for reply in comment.replies.all %}
                        <article class="reply">
                            {% if reply.author.has_profile_image %}
                                <img src="{{ reply.author.profile_image.url }}" alt="{{ reply.author.username }}">
                            {% else %}
                                <img src="{% static 'default/default_profile_image.jpg' %}" alt="{{ reply.author.username }}">
                            {% endif %}
                            <p>On {{ reply.created_on|date:"F j, Y" }} <a href="{% url 'profile' username=reply.author.username %}"><b>{{ reply.author.username }}</b></a> replied:</p>
                            <p>{{ reply.body | linebreaks }}</p>
                            {% if user.is_superuser or user.is_staff %}
                                {% if not reply.approved %}
                                    <form method="post" action="{% url 'reply_approve' reply.id %}">
                                        {% csrf_token %}
                                        <button type="submit">Approve</button>
                                    </form>
                                {% else %}
                                    <p>Approved ✔</p>
                                {% endif %}
                            {% endif %}
                        </article>
                    {% endfor %}
                </div>
            {% endif %}
        </article>
    {% endfor %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.reply-button').click(function() {
                $(this).next('.reply-form').show();
            });
        });
        </script>
</section>

{% endblock page_content %}